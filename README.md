原神伤害计算器重构说明文档 (Moon System & Dynamic Buffs)1. 核心架构理念本次重构将原本“硬编码”的计算逻辑升级为**“动态分发”**架构，核心解决了“加一个Buff要改三个文件”的痛点。动态属性映射 (Dynamic Mapping)：不再在代码里写死每一个 Buff 变量名。main.py 像一个通用快递员，把所有非基础属性（如“月绽放基础值”、“诅咒层数”）打包成一个包裹 (kwargs)，直接扔给计算器。两阶段计算 (2-Pass Calculation)：第一轮：计算面板白值、绿值（攻击、生命、防御等）。第二轮：解析动态公式（如 "hp * 0.2"），实现“属性转模”机制。体系注册表 (System Registry)：将“月绽放”、“月感电”等特殊机制注册为独立体系，自动触发专属公式，不干扰常规逻辑。2. 模块职责分工模块文件角色核心职责修改频率api.py门面定义前端能看到的 Buff 名字列表。低 (仅新增类型时)main.py搬运工负责读取 JSON，解析动态公式，打包参数。它不关心具体业务逻辑。零 (永远不用动)calculator.py大脑纯数学计算核心。接收打包好的参数，执行公式。中 (仅新增数学机制时)characters.json配置源定义角色的技能倍率、Buff 数值和动态公式。高 (日常策划配表)3. 扩展指南：我该怎么改？根据您的需求，分为三种场景：✅ 场景一：调整数值 / 修改公式例子：把拉乌玛的转化率从 20% 改成 30%，或者从固定值改成基于防御力。操作：只修改 characters.json。代码变动：无。✅ 场景二：新增一种普通的 Buff例子：新增一个“月之诅咒”，或者“深渊特攻”，单纯是数值累加。api.py：加一行定义（为了前端显示名字）。characters.json：在角色配置里填入 "type": "moon_curse", "value": 10。calculator.py：在公式里提取并使用它：kwargs.get("moon_curse", 0)。注意：不需要动 main.py，它会自动搬运。✅ 场景三：新增一套全新的伤害体系例子：新增“月感电”，它有独立的精通曲线和防御穿透规则。models.py：在枚举里加一个 MoonElectro。calculator.py：在 MOON_SYSTEM_TYPES 集合里注册 MoonElectro。编写它的精通曲线公式 _get_moon_curve_multiplier。characters.json：将技能的 damage_type 设为 "MoonElectro"。4. 月体系特别说明目前系统已内置以下月体系逻辑，您可直接在 JSON 中配置使用：月绽放 (MoonBloom)：触发：damage_type: "MoonBloom"特征：强制无视防御、不吃常规增伤、吃反比例精通曲线。专用参数：moon_base_flat (基础值), moon_base_pct (倍率), moon_dmg_bonus (独立增伤)。5. 总结这套架构将**业务逻辑（公式）与数据流转（解析）**彻底解耦。以前：加个 Buff -> 改 api -> 改 main (解析) -> 改 calc (计算) -> 容易漏改报错。现在：加个 Buff -> 改 json (配置) -> 改 calc (只写数学公式) -> 完工。